%%%%%%%%%%%%%Parameter%%%%%%%%

% clc
% clear
% Ts=0.1;
% 
% O=[];
% Np=6;
% A=[ 1.049     0.03183    -0.02926
%      0.01347       1.023  -0.0001932
%   -0.0007729     -0.1155      0.9048];
% B=[0.2026  6.946e-05
%    -0.1504     0.1012
%   0.008724    0.08931 ];
% G=[ 5.0468    1.5160   -0.5215
%     1.5160    1.8633   -0.6870
%     -0.5215   -0.6870    1.1919];
% C=eye(3);
% for i=1:Np
%     O=[O;(C*A^(i-1))'];
% end
% [a1,a2]=size(A);
% [n1,n2]=size(B);
% [m1,m2]=size(C);
% F=[];
% for i=0:Np-1
%     s1=[];
%     for j=0:Np-i-2
%         s=[C*A^(j)*B];
%         s1=[s1;s];
%     end
%     S=[ zeros((i+1)*m1,n2);s1];
%     F=[F,S];
% end
% 
% sigma=[];
% for i=0:Np-1
%     si1=[];
%     for j=0:Np-i-2
%         si=[C*A^(j)];
%         si1=[si1;si];
%     end
%     S1=[ zeros((i+1)*m1,a2);si1];
%     sigma=[sigma,S1];
% end
% 
% phi=[];
% for i=0:Np-1
%     ph1=[];
%     for j=0:Np-i-2
%         ph=[C*A^(j)*G];
%         ph1=[ph1;ph];
%     end
%     S2=[ zeros((i+1)*m1,a2);ph1];
%     phi=[phi,S2];
% end
% 
% q=[    1.9115   -1.1429    0.4148
%     3.0186    4.4625   -0.5557];
% q=[2.6427   -1.3599    0.5677
%     2.3465    3.4927    1.2469];
% %%%%%%lqr
% q1=[1.9115   -1.1429    0.4148    0.0000    0.0000   -0.0000    0.0000    0.0000   -0.0000
%     3.0186    4.4625   -0.5557   -0.0000   -0.0000    0.0000   -0.0000   -0.0000    0.0000
%     0.0000    0.0000   -0.0000    1.9115   -1.1429    0.4148    0.0000    0.0000   -0.0000
%    -0.0000   -0.0000    0.0000    3.0186    4.4625   -0.5557   -0.0000   -0.0000    0.0000
%     0.0000    0.0000   -0.0000    0.0000    0.0000   -0.0000    1.9115   -1.1429    0.4148
%    -0.0000   -0.0000    0.0000   -0.0000   -0.0000    0.0000    3.0186    4.4625   -0.5557
%     0.0000    0.0000   -0.0000    0.0000    0.0000    0.0000    0.0000    0.0000   -0.0000
%     0.0000    0.0000   -0.0000    0.0000    0.0000   -0.0000   -0.0000   -0.0000    0.0000
%     0.0000    0.0000   -0.0000   -0.0000   -0.0000    0.0000   -0.0000   -0.0000    0.0000
%     0.0000    0.0000   -0.0000    0.0000    0.0000   -0.0000    0.0000    0.0000   -0.0000
% ];
% q2=[-0.0000   -0.0000    0.0000   -0.0000   -0.0000    0.0000
%     0.0000    0.0000   -0.0000    0.0000    0.0000    0.0000
%     0.0000    0.0000   -0.0000   -0.0000   -0.0000    0.0000
%    -0.0000   -0.0000    0.0000    0.0000    0.0000   -0.0000
%     0.0000    0.0000   -0.0000    0.0000    0.0000   -0.0000
%    -0.0000   -0.0000    0.0000    0.0000    0.0000   -0.0000
%     1.9115   -1.1429    0.4148   -0.0000   -0.0000    0.0000
%     3.0186    4.4625   -0.5557   -0.0000   -0.0000    0.0000
%     0.0000    0.0000   -0.0000    1.9115   -1.1429    0.4148
%    -0.0000   -0.0000    0.0000    3.0186    4.4625   -0.5557
% ];
% %%%%%%%%%%%%%%%%state
% q1=[2.8793   -1.8359    0.9331    2.1018   -1.4682    0.6863    2.2966   -1.5788
%     0.6645    1.9285    0.3000    0.0178    0.9779    0.0312    0.0764    1.1316
%     2.1018   -1.4682    0.6863    3.0398   -1.9226    0.9841    1.6343   -1.2174
%     0.0178    0.9779    0.0312    0.7433    2.0873    0.3323   -0.2244    0.5096
%     2.2966   -1.5788    0.7492    1.6343   -1.2174    0.5379    3.7334   -2.3072
%     0.0764    1.1316    0.0554   -0.2244    0.5096   -0.0684    1.0161    2.6984
%     1.8270   -1.3215    0.5992    2.2205   -1.5413    0.7254    1.3612   -1.0626
%    -0.1297    0.6966   -0.0294    0.0141    1.0339    0.0298   -0.3091    0.2914
%     2.0999   -1.4689    0.6861    2.2081   -1.5238    0.7202    2.1790   -1.5072
%     0.0045    0.9629    0.0258    0.0828    1.0889    0.0582    0.0747    1.0665
% 
% ];
% q2=[0.7492    1.8270   -1.3215    0.5992    2.0999   -1.4689    0.6861
%     0.0554   -0.1297    0.6966   -0.0294    0.0045    0.9629    0.0258
%     0.5379    2.2205   -1.5413    0.7254    2.2081   -1.5238    0.7202
%    -0.0684    0.0141    1.0339    0.0298    0.0828    1.0889    0.0582
%     1.2062    1.3612   -1.0626    0.4499    2.1790   -1.5072    0.7108
%     0.4446   -0.3091    0.2914   -0.1034    0.0747    1.0665    0.0548
%     0.4499    3.5476   -2.2024    1.1464    2.2483   -1.5455    0.7329
%    -0.1034    0.9558    2.5471    0.4197    0.1025    1.1286    0.0663
%     0.7108    2.2483   -1.5455    0.7329    2.4693   -1.6279    0.8039
%     0.0548    0.1025    1.1286    0.0663    0.3691    1.4506    0.1779
% ];
% 
% A0=kron(eye(5),A);
% B0=kron(eye(5),B);
% q=[q1 q2];
% p=[];
% for i=0:Np-1
%     p1=-q*(A0-B0*q)^i;
%     p=[p ;p1];
% end
% [np,mp]=size(p1);
% 
% 
% 
% % % L=[ 1 0 0 0 -1; -1 1 0 0 0; -1 0 1 0 0; 0 -1 0 1 0; 0 -1 -1 -1 3];
% % % A0=kron(eye(5),A);
% % % B0=kron(eye(5),B);
% % % z=kron(L,eye(12));
% % % Q=z'*eye(60)*z;
% % F0=kron(eye(5),F);
% % O0=kron(eye(5),O);
% % %%%%%%%%%%%%qlar
% % %  q1=[0.6456   -0.7472   -0.0583   -0.1918    0.2122   -0.0084   -0.2180    0.2566    0.0076
% % %     0.0247    0.6964    1.7164   -0.0179   -0.2047   -0.5172   -0.0111   -0.2356   -0.5849
% % %    -0.1918    0.2122   -0.0084    0.5911   -0.6705   -0.0725    0.0347    0.0102    0.1024
% % %    -0.0179   -0.2047   -0.5172    0.0220    0.6386    1.5598    0.0509    0.0319    0.1167
% % %    -0.2180    0.2566    0.0076    0.0347    0.0102    0.1024    0.4018   -0.4471   -0.1021
% % %    -0.0111   -0.2356   -0.5849    0.0509    0.0319    0.1167    0.0000    0.4333    1.0389
% % %    -0.0580    0.0834    0.0562   -0.1382    0.2066    0.0657    0.0740   -0.0554    0.0823
% % %     0.0189   -0.0651   -0.1397    0.0257   -0.1543   -0.3605    0.0420    0.0779    0.2200
% % %    -0.1778    0.1950    0.0029   -0.2958    0.2415   -0.0872   -0.2926    0.2357   -0.0902
% % %    -0.0145   -0.1910   -0.4745   -0.0806   -0.3114   -0.7988   -0.0818   -0.3075   -0.7908
% % % 
% % % 
% % % ];
% % % q2=[-0.0580    0.0834    0.0562   -0.1778    0.1950    0.0029
% % %     0.0189   -0.0651   -0.1397   -0.0145   -0.1910   -0.4745
% % %    -0.1382    0.2066    0.0657   -0.2958    0.2415   -0.0872
% % %     0.0257   -0.1543   -0.3605   -0.0806   -0.3114   -0.7988
% % %     0.0740   -0.0554    0.0823   -0.2926    0.2357   -0.0902
% % %     0.0420    0.0779    0.2200   -0.0818   -0.3075   -0.7908
% % %     0.4315   -0.4953   -0.1134   -0.3094    0.2607   -0.0908
% % %    -0.0053    0.4674    1.1181   -0.0813   -0.3259   -0.8379
% % %    -0.3094    0.2607   -0.0908    1.0756   -0.9330    0.2653
% % %    -0.0813   -0.3259   -0.8379    0.2582    1.1358    2.9020
% % % ];
% % 
% % 
% % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % %%%%%%%%%%%%%%%%%state
% % %Kmpc=kron(eye(5),[1 0 0 0 0 0 0 0;0 1 0 0 0  0 0 0])*pinv(F0'*Q*F0+0.1*eye(40))*(F0'*Q*O0)
% % 
% % %%%%%%%%%%%%%%%%%%%%laggure
% % 
% % %%%%%%%%%%%%%%%%%%%%%%%%
% % % q=[q1 q2];
% % q=[    1.9115   -1.1429    0.4148
% %     3.0186    4.4625   -0.5557];
% % p1=-q;
% % p2=-q*(A0-B0*q)^1;
% % p3=-q*(A0-B0*q)^2;
% % p4=-q*(A0-B0*q)^3;
% % p=[p1;p2;p3;p4];
% % 
v=DOS.signals.values;
for i=1:length(DOS.signals.values)
    if v(i)==1
        w(i)=7;
    else
        w(i)=-7;
    end
end


%%%%%%%%%%%%%PLOT FIGURE%%%%%%%%%%%%%%
X =DOS.time;
Y = w;
sh = stairs(X,Y(1:1166));
hold on
bottom = -150;
x = [sh.XData(1),repelem(sh.XData(2:end),2)];
y = [repelem(sh.YData(1:end-1),2),sh.YData(end)];
%%%%%%%%%%%%%%%%%%%%%%
figure (1)
subplot(331)
fill([x,fliplr(x)],[y,bottom*ones(size(y))],[0.6 0.6 0.6])
axis([0 10 -150 150]);
hold on
plot(xlqr.time, xlqr.signals.values,'LineWidth' ,2);
legend('DOS','x11','x12','x13','...');
xlabel('Iteration');
ylabel('x_lqr');
subplot(332)
plot(nxlqr.time, nxlqr.signals.values,'LineWidth' , 2)
legend('norm(e)');
xlabel('Iteration');
ylabel('e_lqr');

grid on
subplot(333)
plot(ulqr.time, ulqr.signals.values,'LineWidth' , 2)
legend('U');
xlabel('Iteration');
ylabel('u_lqr');
grid on

subplot(334)
fill([x,fliplr(x)],[y,bottom*ones(size(y))],[0.6 0.6 0.6])
axis([0 10 -150 150]);
hold on
plot(xwithattack.time, xwithattack.signals.values,'LineWidth' ,2);
legend('DOS','x11','x12','x13','...')
xlabel('Iteration');
ylabel('x_withattack');
subplot(335)
plot(nxwithattack.time, nxwithattack.signals.values,'LineWidth' , 2)
legend('norm(e)');
xlabel('Iteration');
ylabel('e_withattack');
grid on
subplot(336)
plot(uwithattack.time, uwithattack.signals.values,'LineWidth' , 2)
legend('U');
xlabel('Iteration');
ylabel('u_lqr');
grid on
subplot(337)
plot(xwithoutattack.time, xwithoutattack.signals.values,'LineWidth' ,2);
legend('x11','x12','x13','...')
xlabel('Iteration');
ylabel('x_withoutattack');
grid on
subplot(338)
plot(nxwithoutattack.time, nxwithoutattack.signals.values,'LineWidth' , 2)
legend('norm(e)');
xlabel('Iteration');
ylabel('e_withoutattack');
grid on
subplot(339)
plot(uwithoutattack.time, uwithoutattack.signals.values,'LineWidth' , 2)
legend('U');
xlabel('Iteration');
ylabel('u_withoutattack');
grid on
